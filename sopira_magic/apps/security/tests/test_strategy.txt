Testovacia strat√©gia:

text
tests/security/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py                    # Test fixtures a pomocn√© funkcie
‚îú‚îÄ‚îÄ factories.py                   # Test data factories
‚îú‚îÄ‚îÄ test_registry.py              # Registry unit tests
‚îú‚îÄ‚îÄ test_types.py                 # Type definitions tests
‚îú‚îÄ‚îÄ test_config.py               # ‚úÖ SSOT Configuration tests
‚îú‚îÄ‚îÄ test_engine.py               # Engine unit tests
‚îú‚îÄ‚îÄ test_validators/
‚îÇ   ‚îú‚îÄ‚îÄ test_cors.py
‚îÇ   ‚îú‚îÄ‚îÄ test_csrf.py
‚îÇ   ‚îú‚îÄ‚îÄ test_ssl.py
‚îÇ   ‚îú‚îÄ‚îÄ test_headers.py
‚îÇ   ‚îî‚îÄ‚îÄ test_csp.py
‚îú‚îÄ‚îÄ test_middleware.py           # Middleware tests
‚îú‚îÄ‚îÄ test_decorators.py           # Decorators tests
‚îú‚îÄ‚îÄ test_monitoring.py           # Monitoring tests
‚îú‚îÄ‚îÄ test_integration.py          # Integration tests
‚îî‚îÄ‚îÄ test_management.py           # Management commands tests
üìÅ tests/security/test_config.py - SSOT Configuration Tests

python
"""
Unit tests pre SSOT Security Configuration.
Testuje spr√°vnos≈• konfigur√°cie pre v≈°etky environmenty.
"""

import pytest
from django.test import TestCase
from typing import Dict, List

from apps.security.types import EnvironmentType, SecurityLevel
from apps.security.config import SECURITY_CONFIG_MATRIX, EnvironmentConfig


class TestSecurityConfigSSOT(TestCase):
    """
    Testy pre SINGLE SOURCE OF TRUTH - Security Configuration Matrix.
    Zais≈•uje konzistentnos≈• a spr√°vnos≈• v≈°etk√Ωch konfigur√°ci√≠.
    """
    
    def test_config_matrix_structure(self):
        """Test ≈æe konfiguraƒçn√° matica m√° spr√°vnu ≈°trukt√∫ru."""
        # Overenie ≈æe m√°me v≈°etky environmenty
        expected_envs = [EnvironmentType.LOCAL, EnvironmentType.DEVELOPMENT, 
                        EnvironmentType.PRODUCTION, EnvironmentType.CLOUD]
        
        for env in expected_envs:
            assert env in SECURITY_CONFIG_MATRIX, f"Missing config for {env}"
            
            config = SECURITY_CONFIG_MATRIX[env]
            
            # Overenie povinn√Ωch pol√≠
            required_fields = ['name', 'env_type', 'security_level', 'force_https',
                             'allowed_hosts', 'cors', 'csp', 'ssl', 'headers']
            
            for field in required_fields:
                assert field in config, f"Missing field {field} in {env} config"
    
    def test_local_development_config(self):
        """Test konfigur√°cie pre lok√°lny v√Ωvoj."""
        config = SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]
        
        assert config['name'] == "Local Development"
        assert config['env_type'] == EnvironmentType.LOCAL
        assert config['security_level'] == SecurityLevel.MINIMAL
        assert config['force_https'] is False
        
        # CORS testy
        cors = config['cors']
        assert 'http://localhost:5173' in cors['allowed_origins']
        assert 'http://127.0.0.1:5173' in cors['allowed_origins']
        assert cors['allow_credentials'] is True
        
        # SSL testy
        ssl = config['ssl']
        assert ssl['enabled'] is False
        assert ssl['redirect_http'] is False
        assert ssl['hsts_max_age'] == 0
        
        # CSP testy
        csp = config['csp']
        assert "'unsafe-inline'" in csp['script_src']
        assert "'unsafe-eval'" in csp['script_src']
        assert "ws://localhost:*" in csp['connect_src']
    
    def test_development_config(self):
        """Test konfigur√°cie pre dev server."""
        config = SECURITY_CONFIG_MATRIX[EnvironmentType.DEVELOPMENT]
        
        assert config['name'] == "Development Server"
        assert config['env_type'] == EnvironmentType.DEVELOPMENT
        assert config['security_level'] == SecurityLevel.STANDARD
        assert config['force_https'] is True
        
        # Overenie allowed hosts
        allowed_hosts = config['allowed_hosts']
        assert 'dev.thermal-eye.sopira.com' in allowed_hosts
        assert '138.199.224.196' in allowed_hosts
        
        # SSL testy
        ssl = config['ssl']
        assert ssl['enabled'] is True
        assert ssl['redirect_http'] is True
        assert ssl['hsts_max_age'] == 31536000
        assert ssl['certificate_provider'] == 'letsencrypt'
        assert ssl['auto_renew'] is True
    
    def test_production_config(self):
        """Test konfigur√°cie pre produkciu."""
        config = SECURITY_CONFIG_MATRIX[EnvironmentType.PRODUCTION]
        
        assert config['name'] == "Production"
        assert config['env_type'] == EnvironmentType.PRODUCTION
        assert config['security_level'] == SecurityLevel.STRICT
        assert config['force_https'] is True
        
        # CORS testy - produkcia m√° striktn√© povolen√© origins
        cors = config['cors']
        assert len(cors['allowed_origins']) == 2  # Len 2 povolen√© origins
        assert 'https://thermal-eye.sopira.com' in cors['allowed_origins']
        assert 'http://' not in str(cors['allowed_origins'])  # ≈Ωiadne HTTP
        
        # CSP testy - produkcia m√° striktn√© CSP
        csp = config['csp']
        assert "'unsafe-inline'" not in csp['script_src']
        assert "'unsafe-eval'" not in csp['script_src']
        assert "'self'" in csp['script_src']  # Len self
        
        # SSL testy
        ssl = config['ssl']
        assert ssl['hsts_preload'] is True
        assert ssl['renew_before_days'] == 30
    
    def test_cloud_config(self):
        """Test konfigur√°cie pre cloud (Render)."""
        config = SECURITY_CONFIG_MATRIX[EnvironmentType.CLOUD]
        
        assert config['name'] == "Cloud Deployment (Render)"
        assert config['env_type'] == EnvironmentType.CLOUD
        assert config['security_level'] == SecurityLevel.STRICT
        
        # Cloud specific testy
        allowed_hosts = config['allowed_hosts']
        assert 'thermal-eye.onrender.com' in allowed_hosts
        assert '*.onrender.com' in allowed_hosts
        
        # SSL testy pre Render
        ssl = config['ssl']
        assert ssl['certificate_provider'] == 'render'
    
    def test_security_level_progression(self):
        """Test progresie security levels medzi environmentami."""
        security_levels = {
            EnvironmentType.LOCAL: SecurityLevel.MINIMAL,
            EnvironmentType.DEVELOPMENT: SecurityLevel.STANDARD,
            EnvironmentType.PRODUCTION: SecurityLevel.STRICT,
            EnvironmentType.CLOUD: SecurityLevel.STRICT,
        }
        
        for env_type, expected_level in security_levels.items():
            config = SECURITY_CONFIG_MATRIX[env_type]
            assert config['security_level'] == expected_level, \
                f"{env_type} should have {expected_level} security level"
    
    def test_cors_config_consistency(self):
        """Test konzistencie CORS konfigur√°cie."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            cors = config['cors']
            
            # V≈°etky CORS konfigur√°cie musia ma≈• tieto polia
            required_cors_fields = ['allowed_origins', 'allowed_methods', 
                                  'allow_credentials', 'max_age']
            
            for field in required_cors_fields:
                assert field in cors, f"Missing CORS field {field} in {env_type}"
            
            # Max age mus√≠ by≈• kladn√© ƒç√≠slo
            assert cors['max_age'] > 0, f"Invalid max_age in {env_type}"
            
            # Ak je HTTPS vyn√∫ten√©, origins by mali by≈• HTTPS
            if config['force_https']:
                for origin in cors['allowed_origins']:
                    if origin.startswith('http://') and 'localhost' not in origin:
                        pytest.fail(f"HTTP origin in HTTPS environment {env_type}: {origin}")
    
    def test_ssl_config_consistency(self):
        """Test konzistencie SSL konfigur√°cie."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            ssl = config['ssl']
            
            # V≈°etky SSL konfigur√°cie musia ma≈• tieto polia
            required_ssl_fields = ['enabled', 'redirect_http', 'hsts_max_age',
                                 'certificate_provider', 'auto_renew', 'renew_before_days']
            
            for field in required_ssl_fields:
                assert field in ssl, f"Missing SSL field {field} in {env_type}"
            
            # Ak je SSL enabled, redirect_http mus√≠ by≈• True
            if ssl['enabled']:
                assert ssl['redirect_http'] is True, \
                    f"SSL enabled but redirect_http=False in {env_type}"
                
                # HSTS mus√≠ ma≈• pozit√≠vny max_age
                assert ssl['hsts_max_age'] > 0, \
                    f"SSL enabled but HSTS max_age=0 in {env_type}"
    
    @pytest.mark.parametrize("env_type", [
        EnvironmentType.LOCAL,
        EnvironmentType.DEVELOPMENT,
        EnvironmentType.PRODUCTION,
        EnvironmentType.CLOUD,
    ])
    def test_allowed_hosts_not_empty(self, env_type):
        """Test ≈æe allowed_hosts nie je pr√°zdne pre ≈æiadny environment."""
        config = SECURITY_CONFIG_MATRIX[env_type]
        allowed_hosts = config['allowed_hosts']
        
        assert isinstance(allowed_hosts, list)
        assert len(allowed_hosts) > 0, f"Empty allowed_hosts for {env_type}"
        
        # Overenie ≈æe nie s√∫ pr√°zdne stringy
        for host in allowed_hosts:
            assert host.strip() != "", f"Empty string in allowed_hosts for {env_type}"
    
    def test_csp_config_for_all_environments(self):
        """Test CSP konfigur√°cie pre v≈°etky environmenty."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            csp = config['csp']
            
            # Minim√°lne CSP polia
            required_csp_fields = ['default_src', 'script_src', 'style_src']
            
            for field in required_csp_fields:
                assert field in csp, f"Missing CSP field {field} in {env_type}"
                assert isinstance(csp[field], list), \
                    f"CSP field {field} must be list in {env_type}"
                assert len(csp[field]) > 0, \
                    f"Empty CSP {field} in {env_type}"
            
            # default-src mus√≠ obsahova≈• 'self'
            assert "'self'" in csp['default_src'], \
                f"Missing 'self' in default_src for {env_type}"
            
            # object-src a frame-src by mali by≈• 'none' pre bezpeƒçnos≈•
            if 'object_src' in csp:
                assert "'none'" in csp['object_src'], \
                    f"object_src should contain 'none' in {env_type}"
            
            if 'frame_src' in csp:
                assert "'none'" in csp['frame_src'], \
                    f"frame_src should contain 'none' in {env_type}"
    
    def test_headers_config_consistency(self):
        """Test konzistencie security headers."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            headers = config['headers']
            
            # Minim√°lne headers
            required_headers = ['x_frame_options', 'x_content_type_options']
            
            for header in required_headers:
                assert header in headers, f"Missing header {header} in {env_type}"
                assert headers[header], f"Empty header {header} in {env_type}"
            
            # X-Frame-Options mus√≠ by≈• DENY alebo SAMEORIGIN
            valid_frame_options = ['DENY', 'SAMEORIGIN']
            assert headers['x_frame_options'] in valid_frame_options, \
                f"Invalid X-Frame-Options in {env_type}: {headers['x_frame_options']}"
            
            # X-Content-Type-Options mus√≠ by≈• nosniff
            assert headers['x_content_type_options'] == 'nosniff', \
                f"Invalid X-Content-Type-Options in {env_type}"
    
    def test_config_immutability(self):
        """Test ≈æe konfigur√°cia je immutable (nesmie sa meni≈•)."""
        import copy
        
        original_config = copy.deepcopy(SECURITY_CONFIG_MATRIX)
        
        # Pok√∫s sa zmeni≈• konfigur√°ciu
        try:
            SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['name'] = "Modified"
        except TypeError:
            # To je dobre - konfigur√°cia by mala by≈• immutable
            pass
        
        # Overenie ≈æe sa niƒç nezmenilo
        assert SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['name'] == "Local Development"
    
    def test_environment_specific_rules(self):
        """Test environment-specific business rules."""
        
        # Lok√°lny v√Ωvoj nem√° HTTPS
        local_config = SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]
        assert local_config['force_https'] is False
        assert local_config['ssl']['enabled'] is False
        
        # V√Ωvojov√© a produkƒçn√© prostredia maj√∫ HTTPS
        for env in [EnvironmentType.DEVELOPMENT, EnvironmentType.PRODUCTION, EnvironmentType.CLOUD]:
            config = SECURITY_CONFIG_MATRIX[env]
            assert config['force_https'] is True
            assert config['ssl']['enabled'] is True
        
        # Produkcia m√° najpr√≠snej≈°ie CORS
        prod_cors = SECURITY_CONFIG_MATRIX[EnvironmentType.PRODUCTION]['cors']
        assert len(prod_cors['allowed_origins']) <= 2  # Len p√°r povolen√Ωch origins
        
        # Lok√°lny v√Ωvoj m√° najlaxnej≈°ie CORS
        local_cors = SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['cors']
        assert len(local_cors['allowed_origins']) > 2  # Viac origins


class TestSecurityConfigEdgeCases(TestCase):
    """
    Testy pre edge cases v security konfigur√°cii.
    """
    
    def test_wildcard_in_allowed_hosts(self):
        """Test spr√°vnosti wildcard v allowed hosts."""
        cloud_config = SECURITY_CONFIG_MATRIX[EnvironmentType.CLOUD]
        
        # Cloud config by mal podporova≈• wildcard
        assert '*.onrender.com' in cloud_config['allowed_hosts']
        
        # Produkcia by nemala ma≈• wildcard
        prod_config = SECURITY_CONFIG_MATRIX[EnvironmentType.PRODUCTION]
        for host in prod_config['allowed_hosts']:
            assert '*' not in host, f"Wildcard found in production allowed_hosts: {host}"
    
    def test_cors_credentials_with_wildcard(self):
        """
        Test ≈æe CORS withCredentials nie je kombinovan√© s wildcard origin.
        Toto je security anti-pattern.
        """
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            cors = config['cors']
            
            if cors['allow_credentials']:
                # Ak allow_credentials je True, origins nesm√∫ obsahova≈• wildcard
                for origin in cors['allowed_origins']:
                    if '*' in origin:
                        pytest.fail(
                            f"CORS allow_credentials=True but wildcard origin in {env_type}: {origin}"
                        )
    
    def test_ssl_renewal_config(self):
        """Test ≈æe SSL renewal konfigur√°cia je rozumn√°."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            ssl = config['ssl']
            
            if ssl['enabled'] and ssl['auto_renew']:
                # renew_before_days by mal by≈• medzi 7 a 90 d≈àami
                assert 7 <= ssl['renew_before_days'] <= 90, \
                    f"Unreasonable renew_before_days in {env_type}: {ssl['renew_before_days']}"
    
    def test_hsts_configuration(self):
        """Test HSTS konfigur√°cie."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            ssl = config['ssl']
            
            if ssl['enabled']:
                # HSTS max_age by mal by≈• minim√°lne 1 rok v produkcii
                if env_type in [EnvironmentType.PRODUCTION, EnvironmentType.CLOUD]:
                    assert ssl['hsts_max_age'] >= 31536000, \
                        f"HSTS max_age too short for {env_type}: {ssl['hsts_max_age']}"
                
                # HSTS preload vy≈æaduje includeSubDomains
                if ssl['hsts_preload']:
                    assert ssl['hsts_include_subdomains'] is True, \
                        f"HSTS preload requires includeSubDomains in {env_type}"


class TestSecurityConfigValidation(TestCase):
    """
    Testy pre valid√°ciu konfigur√°cie.
    """
    
    def test_validate_all_configs(self):
        """Kompletn√° valid√°cia v≈°etk√Ωch konfigur√°ci√≠."""
        from apps.security.validation import validate_security_config
        
        errors = validate_security_config()
        
        # SSOT konfigur√°cia mus√≠ by≈• bez ch√Ωb
        assert len(errors) == 0, f"Configuration validation errors: {errors}"
    
    def test_environment_type_matching(self):
        """Test ≈æe env_type v konfigur√°cii zodpoved√° kƒæ√∫ƒçu."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            assert config['env_type'] == env_type, \
                f"Config env_type mismatch for {env_type}: {config['env_type']}"
    
    def test_no_duplicate_origins(self):
        """Test ≈æe neexistuj√∫ duplicitn√© CORS origins."""
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            origins = config['cors']['allowed_origins']
            unique_origins = set(origins)
            
            assert len(origins) == len(unique_origins), \
                f"Duplicate origins found in {env_type}: {origins}"
    
    def test_csp_directive_values(self):
        """Test ≈æe CSP directive values s√∫ validn√©."""
        valid_sources = ["'self'", "'none'", "'unsafe-inline'", "'unsafe-eval'",
                        "http:", "https:", "data:", "blob:", "ws:", "wss:"]
        
        for env_type, config in SECURITY_CONFIG_MATRIX.items():
            csp = config['csp']
            
            for directive, sources in csp.items():
                for source in sources:
                    # Skontroluj ƒçi je to validn√Ω source
                    if source not in valid_sources and not source.startswith(('http://', 'https://', 'ws://', 'wss://')):
                        # M√¥≈æe to by≈• dom√©na alebo wildcard
                        if '*' in source:
                            continue  # Wildcard je OK
                        elif '.' in source:
                            continue  # Dom√©na je OK
                        else:
                            pytest.fail(f"Invalid CSP source in {env_type}.{directive}: {source}")


@pytest.mark.parametrize("env_type,expected_security_level", [
    (EnvironmentType.LOCAL, SecurityLevel.MINIMAL),
    (EnvironmentType.DEVELOPMENT, SecurityLevel.STANDARD),
    (EnvironmentType.PRODUCTION, SecurityLevel.STRICT),
    (EnvironmentType.CLOUD, SecurityLevel.STRICT),
])
def test_security_level_parametrized(env_type, expected_security_level):
    """Parametrizovan√Ω test security levels."""
    config = SECURITY_CONFIG_MATRIX[env_type]
    assert config['security_level'] == expected_security_level


class TestSecurityConfigPerformance(TestCase):
    """
    Performance testy pre konfigur√°ciu.
    """
    
    def test_config_access_performance(self):
        """Test r√Ωchlosti pr√≠stupu ku konfigur√°cii."""
        import time
        
        iterations = 1000
        start_time = time.time()
        
        for _ in range(iterations):
            config = SECURITY_CONFIG_MATRIX[EnvironmentType.PRODUCTION]
            _ = config['cors']['allowed_origins']
            _ = config['ssl']['enabled']
        
        elapsed_time = time.time() - start_time
        avg_time = elapsed_time / iterations
        
        # Pr√≠stup ku konfigur√°cii by mal by≈• r√Ωchly (< 0.1ms)
        assert avg_time < 0.0001, f"Config access too slow: {avg_time * 1000:.2f}ms"
    
    def test_config_memory_usage(self):
        """Test ≈æe konfigur√°cia nem√° memory leak."""
        import sys
        
        initial_refs = sys.getrefcount(SECURITY_CONFIG_MATRIX)
        
        # Vytvor veƒæa referenci√≠
        configs = []
        for _ in range(1000):
            configs.append(SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL])
        
        current_refs = sys.getrefcount(SECURITY_CONFIG_MATRIX)
        
        # Poƒçet referenci√≠ by mal by≈• rozumn√Ω
        assert current_refs < initial_refs + 1100, "Possible memory leak in config"
üìÅ tests/security/test_validation.py - SSOT Validation Tests

python
"""
Unit tests pre SSOT validation.
"""

import pytest
from unittest.mock import patch, Mock
from django.test import TestCase

from apps.security.validation import validate_security_config
from apps.security.config import SECURITY_CONFIG_MATRIX, EnvironmentType


class TestSecurityConfigValidation(TestCase):
    """
    Testy pre valid√°ciu SSOT security konfigur√°cie.
    """
    
    def test_validate_empty_config(self):
        """Test valid√°cie s pr√°zdnou konfigur√°ciou."""
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', {}):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "No environment configurations" in str(errors)
    
    def test_validate_missing_required_fields(self):
        """Test valid√°cie s ch√Ωbaj√∫cimi povinn√Ωmi poƒæami."""
        invalid_config = {
            EnvironmentType.LOCAL: {
                'name': 'Test',
                # Ch√Ωbaj√∫ ostatn√© povinn√© polia
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "Missing required field" in str(errors)
    
    def test_validate_invalid_security_level(self):
        """Test valid√°cie s neplatn√Ωm security level."""
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'security_level': 'INVALID_LEVEL'
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "Invalid security level" in str(errors)
    
    def test_validate_invalid_environment_type(self):
        """Test valid√°cie s nezhoduj√∫cim sa environment type."""
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'env_type': EnvironmentType.PRODUCTION  # Nesed√≠ s kƒæ√∫ƒçom
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "does not match key" in str(errors)
    
    def test_validate_cors_credentials_with_wildcard(self):
        """Test valid√°cie CORS credentials s wildcard."""
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'cors': {
                    **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['cors'],
                    'allow_credentials': True,
                    'allowed_origins': ['*']  # Wildcard s credentials
                }
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "CORS allow_credentials with wildcard" in str(errors)
    
    def test_validate_ssl_configuration(self):
        """Test valid√°cie SSL konfigur√°cie."""
        # Test s neplatn√Ωm HSTS max_age
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'ssl': {
                    **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['ssl'],
                    'enabled': True,
                    'hsts_max_age': -1  # Neplatn√Ω
                }
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "Invalid HSTS max_age" in str(errors)
    
    def test_validate_csp_configuration(self):
        """Test valid√°cie CSP konfigur√°cie."""
        # Test s pr√°zdnym CSP
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'csp': {
                    'default_src': []  # Pr√°zdne
                }
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "CSP default_src cannot be empty" in str(errors)
    
    def test_validate_duplicate_origins(self):
        """Test valid√°cie duplicitn√Ωch origins."""
        invalid_config = {
            EnvironmentType.LOCAL: {
                **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL],
                'cors': {
                    **SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]['cors'],
                    'allowed_origins': [
                        'http://localhost:5173',
                        'http://localhost:5173'  # Duplicitn√©
                    ]
                }
            }
        }
        
        with patch('apps.security.validation.SECURITY_CONFIG_MATRIX', invalid_config):
            errors = validate_security_config()
            assert len(errors) > 0
            assert "Duplicate CORS origin" in str(errors)
    
    def test_validate_successful_configuration(self):
        """Test √∫spe≈°nej valid√°cie platnej konfigur√°cie."""
        errors = validate_security_config()
        assert len(errors) == 0, f"Valid configuration should have no errors: {errors}"
    
    def test_validate_all_environments_present(self):
        """Test ≈æe s√∫ pr√≠tomn√© v≈°etky environmenty."""
        errors = validate_security_config()
        
        # Skontroluj ka≈æd√Ω environment
        for env_type in EnvironmentType:
            if env_type not in SECURITY_CONFIG_MATRIX:
                pytest.fail(f"Missing configuration for environment: {env_type}")
üìÅ tests/security/conftest.py - Test Fixtures

python
"""
Test fixtures pre Security Module.
"""

import pytest
from unittest.mock import Mock, patch
from django.http import HttpRequest

from apps.security.types import EnvironmentType, SecurityLevel


@pytest.fixture
def mock_request():
    """Vytvor mock Django request."""
    request = Mock(spec=HttpRequest)
    request.method = 'GET'
    request.META = {}
    request.is_secure.return_value = False
    request.get_host.return_value = 'localhost:8000'
    request.get_full_path.return_value = '/api/test/'
    return request


@pytest.fixture
def mock_https_request():
    """Vytvor mock HTTPS request."""
    request = Mock(spec=HttpRequest)
    request.method = 'GET'
    request.META = {}
    request.is_secure.return_value = True
    request.get_host.return_value = 'thermal-eye.sopira.com'
    request.get_full_path.return_value = '/api/test/'
    return request


@pytest.fixture
def mock_request_with_origin():
    """Vytvor mock request s origin header."""
    request = Mock(spec=HttpRequest)
    request.method = 'GET'
    request.META = {
        'HTTP_ORIGIN': 'http://localhost:5173'
    }
    request.is_secure.return_value = False
    request.get_host.return_value = 'localhost:8000'
    return request


@pytest.fixture
def local_environment_config():
    """Vr√°ti konfigur√°ciu pre lok√°lny v√Ωvoj."""
    from apps.security.config import SECURITY_CONFIG_MATRIX
    return SECURITY_CONFIG_MATRIX[EnvironmentType.LOCAL]


@pytest.fixture
def production_environment_config():
    """Vr√°ti konfigur√°ciu pre produkciu."""
    from apps.security.config import SECURITY_CONFIG_MATRIX
    return SECURITY_CONFIG_MATRIX[EnvironmentType.PRODUCTION]


@pytest.fixture
def mock_environment_detector():
    """Vytvor mock environment detector."""
    def detector(request=None):
        return 'local'
    return detector


@pytest.fixture
def mock_certificate_provider():
    """Vytvor mock certificate provider."""
    def provider(action, domain=None):
        return {
            'valid': True,
            'domain': domain or 'thermal-eye.sopira.com',
            'days_remaining': 365,
            'issuer': 'Let\'s Encrypt'
        }
    return provider


@pytest.fixture
def security_engine_with_mocks(mock_environment_detector, mock_certificate_provider):
    """Vytvor SecurityEngine s mock registry."""
    from apps.security.registry import (
        register_environment_detector,
        register_certificate_provider
    )
    
    # Register mocks
    register_environment_detector(mock_environment_detector)
    register_certificate_provider(mock_certificate_provider)
    
    from apps.security.engine import SecurityEngine
    return SecurityEngine


@pytest.fixture(params=[EnvironmentType.LOCAL, EnvironmentType.PRODUCTION])
def environment_config(request):
    """Parametrizovan√Ω fixture pre environment konfigur√°cie."""
    from apps.security.config import SECURITY_CONFIG_MATRIX
    return SECURITY_CONFIG_MATRIX[request.param]


@pytest.fixture
def all_environment_configs():
    """Vr√°ti v≈°etky environment konfigur√°cie."""
    from apps.security.config import SECURITY_CONFIG_MATRIX
    return SECURITY_CONFIG_MATRIX
üìÅ tests/security/factories.py - Test Data Factories

python
"""
Test data factories pre Security Module.
"""

import factory
from typing import Dict, List
from apps.security.types import EnvironmentType, SecurityLevel


class SecurityConfigFactory:
    """
    Factory pre vytv√°ranie testovac√≠ch security konfigur√°ci√≠.
    """
    
    @staticmethod
    def create_local_config() -> Dict:
        """Vytvor lok√°lnu konfigur√°ciu."""
        return {
            "name": "Local Development",
            "env_type": EnvironmentType.LOCAL,
            "security_level": SecurityLevel.MINIMAL,
            "force_https": False,
            "allowed_hosts": ["localhost", "127.0.0.1"],
            "cors": {
                "allowed_origins": ["http://localhost:5173"],
                "allowed_methods": ["GET", "POST"],
                "allowed_headers": ["*"],
                "allow_credentials": True,
                "max_age": 86400,
            },
            "csp": {
                "default_src": ["'self'"],
                "script_src": ["'self'", "'unsafe-inline'"],
            },
            "ssl": {
                "enabled": False,
                "redirect_http": False,
                "hsts_max_age": 0,
                "hsts_include_subdomains": False,
                "hsts_preload": False,
                "certificate_provider": "none",
                "auto_renew": False,
                "renew_before_days": 30,
            },
            "headers": {
                "x_frame_options": "DENY",
                "x_content_type_options": "nosniff",
            }
        }
    
    @staticmethod
    def create_production_config() -> Dict:
        """Vytvor produkƒçn√∫ konfigur√°ciu."""
        return {
            "name": "Production",
            "env_type": EnvironmentType.PRODUCTION,
            "security_level": SecurityLevel.STRICT,
            "force_https": True,
            "allowed_hosts": ["thermal-eye.sopira.com"],
            "cors": {
                "allowed_origins": ["https://thermal-eye.sopira.com"],
                "allowed_methods": ["GET", "POST", "PUT", "DELETE"],
                "allowed_headers": ["Authorization", "Content-Type"],
                "allow_credentials": True,
                "max_age": 86400,
            },
            "csp": {
                "default_src": ["'self'"],
                "script_src": ["'self'"],
                "style_src": ["'self'"],
            },
            "ssl": {
                "enabled": True,
                "redirect_http": True,
                "hsts_max_age": 31536000,
                "hsts_include_subdomains": True,
                "hsts_preload": True,
                "certificate_provider": "letsencrypt",
                "auto_renew": True,
                "renew_before_days": 30,
            },
            "headers": {
                "x_frame_options": "DENY",
                "x_content_type_options": "nosniff",
                "x_xss_protection": "1; mode=block",
                "referrer_policy": "strict-origin-when-cross-origin",
            }
        }
    
    @staticmethod
    def create_invalid_config() -> Dict:
        """Vytvor neplatn√∫ konfigur√°ciu pre testovanie valid√°cie."""
        return {
            "name": "Invalid Config",
            # Ch√Ωbaj√∫ povinn√© polia
        }
    
    @staticmethod
    def create_cors_config_with_wildcard() -> Dict:
        """Vytvor CORS config s wildcard (nebezpeƒçn√© s credentials)."""
        return {
            "allowed_origins": ["*"],
            "allowed_methods": ["*"],
            "allowed_headers": ["*"],
            "allow_credentials": True,  # Toto je security issue!
            "max_age": 86400,
        }


class RequestFactory:
    """
    Factory pre vytv√°ranie testovac√≠ch requestov.
    """
    
    @staticmethod
    def create_request(
        method='GET',
        host='localhost:8000',
        secure=False,
        origin=None,
        headers=None
    ):
        """Vytvor mock Django request."""
        from unittest.mock import Mock
        
        request = Mock()
        request.method = method
        request.get_host.return_value = host
        request.is_secure.return_value = secure
        request.get_full_path.return_value = '/api/test/'
        
        meta = {}
        if origin:
            meta['HTTP_ORIGIN'] = origin
        
        if headers:
            for key, value in headers.items():
                meta[f'HTTP_{key.upper().replace("-", "_")}'] = value
        
        request.META = meta
        return request